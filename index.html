<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>HACCP Pro Vanilla</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiSEFDQ1AgUHJvIiwiYHNob3J0X25hbWUiOiJIQUNDUCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjZjk3MzE2IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzEwNDYvMTA0Njg1Ny5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ=='>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .page { display: none; padding: 20px; padding-bottom: 80px; }
        .page.active { display: block; }
        .btn { @apply px-4 py-2 rounded-xl font-bold transition active:scale-95 flex items-center justify-center gap-2; }
        .btn-primary { @apply bg-orange-500 text-white shadow-lg; }
        .btn-sec { @apply bg-white border border-gray-200 text-gray-700; }
        .input-box { @apply w-full p-3 border-2 border-gray-200 rounded-xl text-lg outline-none focus:border-orange-500; }
        
        #scanner-overlay { position: fixed; inset: 0; z-index: 99; background: black; display: none; flex-direction: column; }
        #scanner-video { width: 100%; height: 100%; object-fit: cover; }
        .scan-region { position: absolute; top: 40%; left: 10%; right: 10%; height: 150px; border: 2px solid orange; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900">

    <!-- HEADER -->
    <div class="bg-white p-4 sticky top-0 z-10 border-b flex justify-between items-center shadow-sm">
        <div class="font-bold text-lg flex items-center gap-2 text-orange-600"><i data-lucide="layers"></i> HACCP Pro</div>
        <div class="flex gap-2">
            <button onclick="nav('home')" class="p-2 bg-gray-100 rounded"><i data-lucide="plus"></i></button>
            <button onclick="nav('history')" class="p-2 bg-gray-100 rounded"><i data-lucide="history"></i></button>
            <button onclick="nav('settings')" class="p-2 bg-gray-100 rounded"><i data-lucide="settings"></i></button>
        </div>
    </div>

    <!-- HOME -->
    <div id="home" class="page active max-w-lg mx-auto">
        
        <!-- Mode Switch -->
        <div class="flex bg-gray-200 p-1 rounded-xl mb-4">
            <button onclick="setMode('single')" id="btn-single" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-black">SINGOLO</button>
            <button onclick="setMode('recipe')" id="btn-recipe" class="flex-1 py-2 rounded-lg font-bold text-sm text-gray-500">RICETTA</button>
        </div>

        <!-- Categorie -->
        <div id="cat-list" class="flex gap-2 overflow-x-auto pb-2 mb-2"></div>

        <!-- Form -->
        <div class="bg-white p-6 rounded-xl shadow space-y-4 border">
            <div>
                <label class="text-xs font-bold text-gray-400 block mb-1">PRODOTTO</label>
                <select id="sel-prod" class="input-box bg-white"></select>
            </div>

            <!-- Single Mode Fields -->
            <div id="field-single">
                <label class="text-xs font-bold text-gray-400 block mb-1">LOTTO</label>
                <div class="flex gap-2">
                    <input id="inp-lot" class="input-box font-mono uppercase" placeholder="SCAN..." />
                    <button onclick="startScan('main')" class="p-3 bg-orange-100 text-orange-600 rounded-xl"><i data-lucide="camera"></i></button>
                </div>
            </div>

            <!-- Recipe Mode Fields -->
            <div id="field-recipe" class="hidden space-y-4">
                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 flex justify-between items-center">
                    <div><div class="text-[10px] font-bold text-indigo-400">LOTTO INTERNO</div><div id="prep-lot" class="text-xl font-mono font-bold text-indigo-700">...</div></div>
                    <i data-lucide="chef-hat" class="text-indigo-300"></i>
                </div>
                <div id="ing-list" class="space-y-2 text-sm"></div>
                <div class="p-3 bg-gray-50 rounded border space-y-2">
                    <select id="sel-ing" class="w-full p-2 border rounded"></select>
                    <div class="flex gap-2">
                        <input id="inp-ing-qty" class="w-24 p-2 border rounded" placeholder="Q.tà">
                        <div class="flex-1 flex gap-1">
                            <input id="inp-ing-lot" class="flex-1 p-2 border rounded" placeholder="Lotto">
                            <button onclick="startScan('ing')" class="p-2 bg-white border rounded"><i data-lucide="camera" size="16"></i></button>
                        </div>
                    </div>
                    <button onclick="addIng()" class="w-full py-2 bg-slate-800 text-white rounded font-bold text-xs">+ AGGIUNGI</button>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-400 block mb-1">QUANTITÀ</label>
                <input id="inp-qty" class="input-box" placeholder="Es. 5 Kg" />
            </div>

            <button onclick="saveLog()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold shadow-lg text-lg">STAMPA & SALVA</button>
        </div>
    </div>

    <!-- HISTORY -->
    <div id="history" class="page max-w-lg mx-auto">
        <h2 class="font-bold text-xl mb-4">Storico</h2>
        <div id="log-list" class="space-y-3"></div>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="page max-w-lg mx-auto space-y-6">
        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
            <h3 class="font-bold text-blue-900 mb-2">Cloud Sync</h3>
            <div class="flex gap-2">
                <input id="inp-cloud" class="w-full p-2 border rounded text-sm" placeholder="URL Google Script..." />
                <button onclick="saveCloud()" class="bg-blue-600 text-white px-3 rounded font-bold">OK</button>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow space-y-4">
            <h3 class="font-bold">Gestione Menu</h3>
            <div class="flex gap-2">
                <input id="new-cat" class="flex-1 border p-2 rounded" placeholder="Nuova Categoria" />
                <button onclick="addCat()" class="bg-slate-900 text-white px-4 rounded font-bold">+</button>
            </div>
            <div id="settings-cats" class="flex flex-wrap gap-2"></div>
            <div class="border-t pt-4">
                <div class="flex gap-2 mb-2">
                    <input id="new-prod" class="flex-1 border p-2 rounded" placeholder="Nuovo Prodotto" />
                    <button onclick="addProd()" class="bg-blue-600 text-white px-4 rounded font-bold">+</button>
                </div>
                <div id="settings-prods" class="max-h-60 overflow-y-auto space-y-1"></div>
            </div>
        </div>
        
        <div class="text-center">
            <button onclick="resetApp()" class="text-red-500 text-xs underline">RESET TOTALE</button>
        </div>
    </div>

    <!-- SCANNER OVERLAY -->
    <div id="scanner-overlay">
        <div class="absolute top-0 w-full p-4 flex justify-between text-white z-20">
            <span class="font-bold">SCANNER</span>
            <button onclick="closeScan()"><i data-lucide="x"></i></button>
        </div>
        <div class="relative flex-1 bg-black">
            <video id="scanner-video" autoplay playsinline></video>
            <div class="scan-region"></div>
            <div id="scan-status" class="absolute inset-0 flex items-center justify-center text-white font-bold bg-black/50 hidden">ANALISI...</div>
        </div>
        <div class="bg-slate-900 p-8 flex justify-center z-20">
            <button onclick="takePhoto()" class="flex flex-col items-center text-white gap-2">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-black border-4 border-slate-700"><i data-lucide="camera" size="32"></i></div>
                <span class="text-xs font-bold">SCATTA</span>
            </button>
        </div>
        <canvas id="scan-canvas" class="hidden"></canvas>
    </div>

    <script>
        // --- STATE ---
        let DATA = {
            inventory: { impasti: { id: 'impasti', name: 'Impasti', products: ['Impasto Pizza'] } },
            logs: [],
            mode: 'single', // single | recipe
            catId: 'impasti',
            ingredients: [],
            scanTarget: ''
        };

        // --- INIT ---
        function init() {
            lucide.createIcons();
            loadData();
            renderCats();
            renderProds();
            renderLogs();
            updatePrepLot();
        }

        function loadData() {
            const i = localStorage.getItem('h_inv'); if(i) DATA.inventory = JSON.parse(i);
            const l = localStorage.getItem('h_logs'); if(l) DATA.logs = JSON.parse(l);
            const u = localStorage.getItem('h_url'); if(u) document.getElementById('inp-cloud').value = u;
            // Select first cat
            if(!DATA.inventory[DATA.catId] && Object.keys(DATA.inventory).length) DATA.catId = Object.keys(DATA.inventory)[0];
        }

        // --- NAVIGATION ---
        window.nav = (page) => {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            if(page === 'settings') renderSettings();
        };

        window.setMode = (m) => {
            DATA.mode = m;
            document.getElementById('btn-single').className = m==='single' ? 'flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-black' : 'flex-1 py-2 rounded-lg font-bold text-sm text-gray-500';
            document.getElementById('btn-recipe').className = m==='recipe' ? 'flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-indigo-600' : 'flex-1 py-2 rounded-lg font-bold text-sm text-gray-500';
            
            document.getElementById('field-single').classList.toggle('hidden', m !== 'single');
            document.getElementById('field-recipe').classList.toggle('hidden', m !== 'recipe');
        };

        // --- RENDERERS ---
        function renderCats() {
            const div = document.getElementById('cat-list');
            div.innerHTML = Object.values(DATA.inventory).map(c => 
                `<button onclick="setCat('${c.id}')" class="px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap ${DATA.catId===c.id?'bg-orange-500 text-white':'bg-white'}">${c.name}</button>`
            ).join('');
        }

        function renderProds() {
            const sel = document.getElementById('sel-prod');
            const prods = DATA.inventory[DATA.catId]?.products || [];
            sel.innerHTML = prods.map(p => `<option value="${p}">${p}</option>`).join('');
        }
        
        function renderLogs() {
            const div = document.getElementById('log-list');
            div.innerHTML = DATA.logs.map(l => `
                <div class="bg-white p-4 rounded-xl shadow border flex justify-between items-center">
                    <div><div class="font-bold">${l.prod}</div><div class="text-xs text-gray-500">${l.lot} • ${l.qty}</div></div>
                    <div class="text-xs text-gray-400">${l.date}</div>
                </div>
            `).join('');
        }

        window.setCat = (id) => { DATA.catId = id; renderCats(); renderProds(); };

        // --- ACTIONS ---
        window.addIng = () => {
            const sel = document.getElementById('sel-ing'); // Populate this first
            // For simplicity in Vanilla, we use prompt or simple inputs for recipe adding
            // Re-rendering recipe UI is complex in Vanilla, keeping it minimal
        };

        window.saveLog = async () => {
            const prod = document.getElementById('sel-prod').value;
            const qty = document.getElementById('inp-qty').value;
            let lot = document.getElementById('inp-lot').value;

            if(DATA.mode === 'recipe') {
                // Logic for recipe saving
                lot = document.getElementById('prep-lot').innerText;
            }

            if(!lot) return alert("Manca Lotto");

            const item = { id: Date.now(), date: new Date().toLocaleDateString(), cat: DATA.inventory[DATA.catId].name, prod, lot, qty, type: DATA.mode };
            
            DATA.logs.unshift(item);
            localStorage.setItem('h_logs', JSON.stringify(DATA.logs));
            
            // Cloud Sync
            const url = document.getElementById('inp-cloud').value;
            if(url) fetch(url, { method:'POST', mode:'no-cors', body:JSON.stringify(item) }).catch(()=>{});

            // Print
            await printBT(item);

            alert("Salvato!");
            document.getElementById('inp-lot').value = '';
            document.getElementById('inp-qty').value = '';
            renderLogs();
        };

        // --- SETTINGS ---
        window.saveCloud = () => { localStorage.setItem('h_url', document.getElementById('inp-cloud').value); alert('OK'); };
        
        function renderSettings() {
            const cDiv = document.getElementById('settings-cats');
            cDiv.innerHTML = Object.values(DATA.inventory).map(c => 
                `<button onclick="setCat('${c.id}');renderSettings()" class="px-2 py-1 border rounded text-xs ${DATA.catId===c.id?'bg-orange-100':''}">${c.name} <span onclick="delCat('${c.id}')" class="text-red-500 font-bold ml-1">x</span></button>`
            ).join('');

            const pDiv = document.getElementById('settings-prods');
            const prods = DATA.inventory[DATA.catId]?.products || [];
            pDiv.innerHTML = prods.map(p => 
                `<div class="flex justify-between p-2 border rounded bg-slate-50 text-sm"><span>${p}</span><button onclick="delProd('${p}')" class="text-red-500">x</button></div>`
            ).join('');
        }

        window.addCat = () => {
            const val = document.getElementById('new-cat').value;
            if(!val) return;
            const id = val.toLowerCase().replace(/\s/g,'');
            DATA.inventory[id] = { id, name: val, products:[] };
            localStorage.setItem('h_inv', JSON.stringify(DATA.inventory));
            document.getElementById('new-cat').value = '';
            renderSettings();
        };
        
        window.addProd = () => {
            const val = document.getElementById('new-prod').value;
            if(!val) return;
            DATA.inventory[DATA.catId].products.push(val);
            localStorage.setItem('h_inv', JSON.stringify(DATA.inventory));
            document.getElementById('new-prod').value = '';
            renderSettings();
        };

        window.delCat = (id) => { if(confirm('?')) { delete DATA.inventory[id]; localStorage.setItem('h_inv', JSON.stringify(DATA.inventory)); renderSettings(); } };
        window.delProd = (p) => { if(confirm('?')) { const c=DATA.inventory[DATA.catId]; c.products = c.products.filter(x=>x!==p); localStorage.setItem('h_inv', JSON.stringify(DATA.inventory)); renderSettings(); } };
        window.resetApp = () => { if(confirm('RESET?')) { localStorage.clear(); location.reload(); } };

        // --- SCANNER LOGIC ---
        window.startScan = (target) => {
            DATA.scanTarget = target;
            document.getElementById('scanner-overlay').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => { document.getElementById('scanner-video').srcObject = stream; })
                .catch(e => alert("Errore camera: " + e));
        };

        window.closeScan = () => {
            document.getElementById('scanner-overlay').style.display = 'none';
            const vid = document.getElementById('scanner-video');
            if(vid.srcObject) vid.srcObject.getTracks().forEach(t => t.stop());
        };

        window.takePhoto = async () => {
            const vid = document.getElementById('scanner-video');
            const cvs = document.getElementById('scan-canvas');
            const ctx = cvs.getContext('2d');
            
            document.getElementById('scan-status').classList.remove('hidden');
            
            cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
            ctx.drawImage(vid, 0, 0);
            
            // Crop center
            const w = cvs.width, h = cvs.height;
            const cw = w * 0.8, ch = h * 0.25;
            const cropCvs = document.createElement('canvas');
            cropCvs.width = cw; cropCvs.height = ch;
            cropCvs.getContext('2d').drawImage(cvs, (w-cw)/2, (h-ch)/2, cw, ch, 0, 0, cw, ch);

            try {
                const res = await Tesseract.recognize(cropCvs.toDataURL('image/jpeg'), 'eng');
                const txt = res.data.text.replace(/[^A-Z0-9\-\/]/g, '').trim();
                if(txt.length > 2) {
                    if(DATA.scanTarget === 'main') document.getElementById('inp-lot').value = txt;
                    else document.getElementById('inp-ing-lot').value = txt;
                    closeScan();
                } else alert("Riprova");
            } catch(e) { alert("Errore OCR"); }
            document.getElementById('scan-status').classList.add('hidden');
        };

        function updatePrepLot() {
            const c = parseInt(localStorage.getItem('prep_c')||'0')+1;
            document.getElementById('prep-lot').innerText = `PREP-${String(c).padStart(4,'0')}`;
        }
        
        // --- PRINT ---
        async function printBT(item) {
             // Mock print for vanilla
             console.log("Printing", item);
        }

        // Start
        init();
    </script>
</body>
</html>
