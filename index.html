import React, { useState, useEffect, useRef } from 'react';
import { 
  Layers, Plus, History, Settings, Printer, Trash2, X, Camera, 
  ScanLine, Zap, ChevronRight, Edit3, Save, ChefHat, Package, Check, ArrowRight,
  FileText, Bluetooth, List, Lock, Smartphone, Share, MoreVertical, Cloud, Link as LinkIcon,
  Download, Upload, FileSpreadsheet, BluetoothConnected
} from 'lucide-react';
import SmartLotInput from './components/SmartLotInput';
import Button from './components/Button';

// --- TIPI ---
interface Inventory {
    [key: string]: { id: string; name: string; products: string[] };
}

interface Ingredient {
    name: string;
    lot: string;
    qty: string;
}

interface LogItem {
    id: string;
    date: string;
    cat: string;
    prod: string; 
    lot: string; 
    qty: string; 
    type: string;
    ingredients?: Ingredient[];
}

const DEFAULT_DATA: Inventory = {
    impasti: { id: 'impasti', name: 'Impasti', products: ['Impasto Pizza', 'Pane', 'Integrale'] },
    cucina: { id: 'cucina', name: 'Cucina', products: ['Sugo', 'Verdure', 'Patate'] },
    frigo: { id: 'frigo', name: 'Frigo', products: ['Mozzarella', 'Prosciutto', 'Salame'] }
};

// --- COMPONENTE GESTIONE MENU ---
const MenuManager = ({ inventory, onUpdate }: { inventory: Inventory, onUpdate: (inv: Inventory) => void }) => {
    const [newCat, setNewCat] = useState('');
    const [newProd, setNewProd] = useState('');
    const [selCat, setSelCat] = useState(() => Object.keys(inventory)[0] || '');
    const [cloudUrl, setCloudUrl] = useState('');
    const [isSavedUrl, setIsSavedUrl] = useState(false);
    const fileInputRef = useRef<HTMLInputElement>(null);

    useEffect(() => {
        if (selCat && !inventory[selCat] && Object.keys(inventory).length > 0) {
            setSelCat(Object.keys(inventory)[0]);
        } else if (!selCat && Object.keys(inventory).length > 0) {
            setSelCat(Object.keys(inventory)[0]);
        }
        const savedUrl = localStorage.getItem('haccp_cloud_url');
        if(savedUrl) setCloudUrl(savedUrl);
    }, [inventory, selCat]);

    const saveCloudUrl = () => { localStorage.setItem('haccp_cloud_url', cloudUrl.trim()); setIsSavedUrl(true); setTimeout(()=>setIsSavedUrl(false), 2000); };
    const addCategory = () => { if (!newCat.trim()) return; const id = newCat.toLowerCase().replace(/\s+/g, ''); if (inventory[id]) return alert("Esiste già"); onUpdate({ ...inventory, [id]: { id, name: newCat, products: [] } }); setNewCat(''); setSelCat(id); };
    const deleteCategory = (id: string) => { if (!confirm("Eliminare intera categoria?")) return; const updated = { ...inventory }; delete updated[id]; onUpdate(updated); };
    const addProduct = () => { if (!newProd.trim() || !selCat) return; const cat = inventory[selCat]; onUpdate({ ...inventory, [selCat]: { ...cat, products: [...cat.products, newProd.trim()] } }); setNewProd(''); };
    const deleteProduct = (prodName: string) => { if (!confirm("Eliminare prodotto?")) return; const cat = inventory[selCat]; onUpdate({ ...inventory, [selCat]: { ...cat, products: cat.products.filter(p => p !== prodName) } }); };

    const exportCSV = () => {
        let csv = "Categoria,Prodotto\n";
        Object.values(inventory).forEach(c => c.products.forEach(p => csv += `${c.name},${p}\n`));
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        a.download = 'menu_haccp.csv';
        a.click();
    };

    const importCSV = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const text = evt.target?.result as string;
            const lines = text.split('\n');
            const newInv = { ...inventory };
            lines.forEach((l, i) => {
                if(i===0) return;
                const [c, p] = l.split(',');
                if(c && p) {
                    const id = c.trim().toLowerCase().replace(/\s+/g, '');
                    if(!newInv[id]) newInv[id] = { id, name: c.trim(), products: [] };
                    const prodName = p.trim();
                    if(!newInv[id].products.includes(prodName)) newInv[id].products.push(prodName);
                }
            });
            onUpdate(newInv);
            alert('Menu Importato!');
        };
        reader.readAsText(file);
    };

    return (
        <div className="p-4 md:p-8 space-y-8 pb-20 animate-in fade-in max-w-5xl mx-auto">
            {/* CLOUD & BACKUP */}
            <div className="grid md:grid-cols-2 gap-4">
                <div className="bg-blue-50 border border-blue-200 p-6 rounded-2xl shadow-sm">
                    <h3 className="font-bold text-blue-900 flex items-center gap-2 mb-2"><Cloud size={20}/> Cloud Sync (Google)</h3>
                    <div className="flex gap-2">
                        <div className="relative flex-1">
                            <LinkIcon size={16} className="absolute left-3 top-3.5 text-blue-400"/>
                            <input className="w-full pl-9 pr-3 py-3 border border-blue-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-400" placeholder="URL Google Script..." value={cloudUrl} onChange={e => setCloudUrl(e.target.value)}/>
                        </div>
                        <button onClick={saveCloudUrl} className={`px-6 rounded-xl font-bold text-white transition-all ${isSavedUrl?'bg-green-500':'bg-blue-600 hover:bg-blue-700'}`}>{isSavedUrl?<Check/>:'SALVA'}</button>
                    </div>
                </div>
                
                <div className="bg-emerald-50 border border-emerald-200 p-6 rounded-2xl shadow-sm">
                    <h3 className="font-bold text-emerald-900 flex items-center gap-2 mb-4"><FileSpreadsheet size={20}/> Backup Menu</h3>
                    <div className="flex gap-3">
                        <button onClick={exportCSV} className="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow hover:bg-emerald-700"><Download size={18}/> EXPORT</button>
                        <button onClick={()=>fileInputRef.current?.click()} className="flex-1 bg-white border-2 border-emerald-600 text-emerald-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow hover:bg-emerald-50"><Upload size={18}/> IMPORT</button>
                        <input type="file" ref={fileInputRef} onChange={importCSV} accept=".csv" className="hidden" />
                    </div>
                </div>
            </div>

            <h2 className="font-bold text-2xl flex gap-3 items-center text-slate-800"><Settings className="text-orange-500" size={28}/> Gestione Menu</h2>
            
            <div className="grid md:grid-cols-12 gap-6">
                <div className="md:col-span-4 space-y-4">
                    <div className="bg-white p-4 rounded-2xl border shadow-sm">
                        <label className="text-xs font-bold text-slate-400 mb-2 block uppercase">Nuova Categoria</label>
                        <div className="flex gap-2">
                            <input className="flex-1 p-3 border rounded-xl" placeholder="Nome..." value={newCat} onChange={e => setNewCat(e.target.value)}/>
                            <button onClick={addCategory} className="bg-slate-900 text-white px-4 rounded-xl font-bold">OK</button>
                        </div>
                    </div>
                    <div className="bg-white rounded-2xl border shadow-sm overflow-hidden p-2 space-y-1">
                        {Object.values(inventory).map(c => (
                            <button key={c.id} onClick={() => setSelCat(c.id)} className={`w-full text-left px-4 py-3 rounded-xl font-bold flex justify-between items-center ${selCat === c.id ? 'bg-orange-50 text-orange-600 ring-1 ring-orange-200' : 'text-slate-600 hover:bg-slate-50'}`}>
                                {c.name}
                                {selCat === c.id && <span onClick={(e) => { e.stopPropagation(); deleteCategory(c.id); }} className="p-1 hover:bg-red-100 text-red-400 rounded"><Trash2 size={16}/></span>}
                            </button>
                        ))}
                    </div>
                </div>

                <div className="md:col-span-8 bg-white rounded-2xl border shadow-sm h-[500px] flex flex-col">
                    <div className="p-4 border-b bg-slate-50 font-bold text-slate-700">PRODOTTI: <span className="text-orange-600 uppercase">{inventory[selCat]?.name}</span></div>
                    <div className="p-4 border-b flex gap-2">
                        <input className="flex-1 p-3 border rounded-xl" placeholder="Nuovo prodotto..." value={newProd} onChange={e => setNewProd(e.target.value)} onKeyDown={e => e.key === 'Enter' && addProduct()}/>
                        <button onClick={addProduct} className="bg-blue-600 text-white px-6 rounded-xl font-bold"><Plus/></button>
                    </div>
                    <div className="p-4 flex-1 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-3 content-start">
                        {inventory[selCat]?.products.map((p, idx) => (
                            <div key={idx} className="flex justify-between items-center p-3 bg-slate-50 rounded-xl border hover:border-blue-300">
                                <span className="font-medium">{p}</span>
                                <button onClick={() => deleteProduct(p)} className="text-slate-300 hover:text-red-500"><X/></button>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- HELPER STAMPA ---
const wrapText = (text: string, maxChars: number) => {
    if(!text) return [""];
    const words = text.split(' ');
    let lines: string[] = [];
    let currentLine = words[0];
    for (let i = 1; i < words.length; i++) {
        if (currentLine.length + 1 + words[i].length <= maxChars) currentLine += ' ' + words[i];
        else { lines.push(currentLine); currentLine = words[i]; }
    }
    lines.push(currentLine);
    return lines;
};

// --- APP PRINCIPALE ---
export default function App() {
    const [view, setView] = useState<'home'|'history'|'menu'>('home');
    const [mode, setMode] = useState<'single'|'recipe'>('single');
    const [inventory, setInventory] = useState<Inventory>(DEFAULT_DATA);
    const [logs, setLogs] = useState<LogItem[]>([]);
    
    // Form
    const [catId, setCatId] = useState('impasti');
    const [prod, setProd] = useState('');
    const [lot, setLot] = useState('');
    const [qty, setQty] = useState('');
    const [prepLot, setPrepLot] = useState('');
    
    // Recipe
    const [ingredients, setIngredients] = useState<Ingredient[]>([]);
    const [newIngName, setNewIngName] = useState('');
    const [newIngLot, setNewIngLot] = useState('');
    const [newIngQty, setNewIngQty] = useState('');

    // Bluetooth
    const [btDevice, setBtDevice] = useState<any>(null);
    const printerCache = useRef<any>(null);

    // Caricamento Dati
    useEffect(() => {
        try {
            const i = localStorage.getItem('haccp_inv_v5'); if(i) setInventory(JSON.parse(i));
            const l = localStorage.getItem('haccp_logs_v5'); if(l) setLogs(JSON.parse(l));
        } catch(e) { console.error(e); }
        generatePrepLot();
    }, []);

    useEffect(() => {
        if (inventory[catId]) {
            if (inventory[catId].products.length > 0) setProd(inventory[catId].products[0]);
            else setProd('');
        } else if (Object.keys(inventory).length > 0) {
            setCatId(Object.keys(inventory)[0]);
        }
    }, [inventory, catId]);

    const saveInv = (n: Inventory) => { setInventory(n); localStorage.setItem('haccp_inv_v5', JSON.stringify(n)); };
    
    const generatePrepLot = () => {
        const count = parseInt(localStorage.getItem('prep_count') || '0') + 1;
        setPrepLot(`PREP-${String(count).padStart(4, '0')}`);
    };

    const addIngredient = () => {
        if(!newIngName || !newIngQty) return alert("Inserisci nome e quantità");
        setIngredients([...ingredients, { name: newIngName, lot: newIngLot || 'N/A', qty: newIngQty }]);
        setNewIngName(''); setNewIngLot(''); setNewIngQty('');
    };

    const addLog = async (e: React.FormEvent) => {
        e.preventDefault();
        let finalLot = lot;
        let finalIngs = undefined;

        if (mode === 'recipe') {
            if(ingredients.length === 0) return alert("Aggiungi ingredienti");
            finalLot = prepLot;
            finalIngs = ingredients;
            localStorage.setItem('prep_count', (parseInt(localStorage.getItem('prep_count')||'0')+1).toString());
            generatePrepLot();
        } else {
            if(!lot) return alert("Inserisci Lotto");
        }
        
        const newItem: LogItem = {
            id: Date.now().toString(),
            date: new Date().toISOString().split('T')[0],
            cat: inventory[catId]?.name || 'Varie',
            prod: prod || 'Prodotto',
            lot: finalLot,
            qty,
            type: mode,
            ingredients: finalIngs
        };
        
        const newLogs = [newItem, ...logs];
        setLogs(newLogs);
        localStorage.setItem('haccp_logs_v5', JSON.stringify(newLogs));
        
        // Cloud
        const cloudUrl = localStorage.getItem('haccp_cloud_url');
        if (cloudUrl) {
            fetch(cloudUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newItem)
            }).catch(console.error);
        }

        await printBT(newItem);
        setLot(''); setQty(''); setIngredients([]);
    };

    const printBT = async (item: LogItem) => {
        try {
            let device = printerCache.current;
            let server;

            if (device && device.gatt.connected) {
                server = device.gatt;
            } else {
                // @ts-ignore
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: '4B-2054L' }],
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
                });
                server = await device.gatt.connect();
                printerCache.current = device;
                setBtDevice(device);
                device.addEventListener('gattserverdisconnected', () => { 
                    printerCache.current = null; 
                    setBtDevice(null);
                });
            }

            const svc = await server.getPrimaryServices();
            // @ts-ignore
            const char = (await svc[0].getCharacteristics()).find(c => c.properties.write || c.properties.writeWithoutResponse);
            if(!char) throw new Error("No Write");

            const enc = new TextEncoder();
            let cmds = `SIZE 60 mm,40 mm\nCLS\nBOX 10,10,470,310,3\n`;
            let y = 30;

            const prodLines = wrapText(item.prod, 18);
            prodLines.forEach(l => { cmds += `TEXT 240,${y},"3",0,1,1,2,"${l}"\n`; y+=35; });
            
            cmds += `TEXT 240,${y},"2",0,1,1,2,"(${item.cat})"\n`; y+=30;
            cmds += `BAR 10,${y},460,2\n`; y+=10;
            cmds += `TEXT 30,${y},"2",0,1,1,"L: ${item.lot}"\n`;
            cmds += `TEXT 300,${y},"2",0,1,1,"Q: ${item.qty}"\n`;
            y+=35;

            if (item.type === 'recipe' && item.ingredients) {
                item.ingredients.forEach((ing) => {
                    const lineStr = `- ${ing.name} [${ing.lot}]`;
                    const iLines = wrapText(lineStr, 40);
                    iLines.forEach(l => {
                        if(y < 265) { cmds += `TEXT 20,${y},"1",0,1,1,"${l}"\n`; y+=20; }
                    });
                });
            }

            cmds += `BAR 10,270,460,2\nTEXT 30,285,"2",0,1,1,"${item.date}"\nTEXT 300,285,"2",0,1,1,"Scad: +3gg"\nPRINT 1\nEND`;
            
            const data = enc.encode(cmds);
            for(let i=0; i<data.length; i+=100) await char.writeValue(data.slice(i, i+100));

        } catch(e) { 
            alert("Stampa BT fallita. Uso browser.");
            window.print(); 
        }
    };

    return (
        <div className="min-h-screen bg-slate-50 flex flex-col pb-safe">
            {!window.isSecureContext && <div className="bg-amber-100 text-amber-800 p-2 text-center text-xs font-bold">HTTPS NECESSARIO</div>}

            <header className="bg-white p-4 sticky top-0 z-30 border-b flex justify-between items-center shadow-sm">
                <div className="font-bold text-lg flex items-center gap-2"><Layers className="text-orange-500"/> HACCP Pro</div>
                <div className="flex gap-2">
                    <button onClick={()=>setView('home')} className={`p-2 rounded-lg transition-all ${view==='home'?'bg-slate-100 text-slate-900':'text-slate-400'}`}><Plus size={24}/></button>
                    <button onClick={()=>setView('history')} className={`p-2 rounded-lg transition-all ${view==='history'?'bg-slate-100 text-slate-900':'text-slate-400'}`}><History size={24}/></button>
                    <button onClick={()=>setView('menu')} className={`p-2 rounded-lg transition-all ${view==='menu'?'bg-slate-100 text-slate-900':'text-slate-400'}`}><Settings size={24}/></button>
                </div>
            </header>

            <main className="flex-1 p-4 overflow-y-auto">
                {view === 'home' && (
                    <div className="max-w-5xl mx-auto animate-in fade-in grid md:grid-cols-12 gap-6">
                        <div className="md:col-span-5 space-y-4">
                            <div className="flex bg-slate-200 p-1 rounded-2xl">
                                <button onClick={()=>setMode('single')} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${mode==='single'?'bg-white shadow text-slate-900':'text-slate-500'}`}>SINGOLO</button>
                                <button onClick={()=>setMode('recipe')} className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${mode==='recipe'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>RICETTA</button>
                            </div>
                            <div className="bg-white p-4 rounded-2xl border shadow-sm flex flex-wrap gap-2">
                                {Object.values(inventory).map(c => <button key={c.id} onClick={()=>{setCatId(c.id); if(c.products.length) setProd(c.products[0]); else setProd('')}} className={`px-4 py-2 rounded-lg font-bold text-sm border transition-all ${catId===c.id?'bg-orange-500 text-white':'bg-slate-50 border-slate-200'}`}>{c.name}</button>)}
                            </div>
                            <div className="bg-white p-4 rounded-2xl border shadow-sm">
                                <select className="w-full p-4 bg-slate-50 border-2 rounded-xl font-bold text-lg outline-none" value={prod} onChange={e=>setProd(e.target.value)}>{inventory[catId]?.products.map(p=><option key={p} value={p}>{p}</option>)}</select>
                            </div>
                        </div>
                        <div className="md:col-span-7 bg-white p-6 rounded-2xl border shadow-sm">
                            <form onSubmit={addLog} className="space-y-6">
                                {mode==='single' ? (
                                    <div><label className="text-xs font-bold text-slate-400 mb-1 block">LOTTO ORIGINE</label><SmartLotInput label="" value={lot} onChange={setLot}/></div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex justify-between items-center"><div><div className="text-[10px] font-bold text-indigo-400">LOTTO INTERNO</div><div className="text-2xl font-mono font-bold text-indigo-700">{prepLot}</div></div><ChefHat className="text-indigo-300" size={32}/></div>
                                        <div className="space-y-2">{ingredients.map((ing, i) => <div key={i} className="flex justify-between items-center bg-slate-50 p-3 rounded-lg text-sm border"><span className="font-bold">{ing.name} ({ing.qty})</span><span className="font-mono text-xs">{ing.lot}</span></div>)}</div>
                                        <div className="p-4 bg-slate-50 rounded-xl border space-y-3"><select className="w-full p-3 border rounded-lg bg-white" value={newIngName} onChange={e=>setNewIngName(e.target.value)}><option value="">Seleziona...</option>{Object.values(inventory).map(c=><optgroup key={c.id} label={c.name}>{c.products.map(p=><option key={p} value={p}>{p}</option>)}</optgroup>)}</select><div className="flex gap-2"><input className="w-24 p-3 border rounded-lg" placeholder="Q.tà" value={newIngQty} onChange={e=>setNewIngQty(e.target.value)}/><div className="flex-1"><SmartLotInput label="" value={newIngLot} onChange={setNewIngLot}/></div></div><button type="button" onClick={addIngredient} className="w-full py-3 bg-slate-800 text-white rounded-lg font-bold text-sm">+ AGGIUNGI</button></div>
                                    </div>
                                )}
                                <div><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">QUANTITÀ</label><input value={qty} onChange={e=>setQty(e.target.value)} className="w-full p-4 border-2 rounded-xl font-bold text-lg" placeholder="Es. 5 Kg"/></div>
                                <Button type="submit" fullWidth className="py-5 text-xl shadow-xl">{btDevice ? 'STAMPA DIRETTA' : 'CONNETTI E STAMPA'}</Button>
                            </form>
                        </div>
                    </div>
                )}

                {view === 'history' && (
                    <div className="max-w-2xl mx-auto space-y-4">
                        <h2 className="font-bold text-2xl mb-6 text-slate-800">Storico</h2>
                        {logs.map(l => (
                            <div key={l.id} className="bg-white p-5 rounded-2xl border shadow-sm flex flex-col gap-3">
                                <div className="flex justify-between items-start">
                                    <div><span className="font-bold text-lg text-slate-800">{l.prod}</span><div className="text-sm text-slate-500">Lotto: {l.lot} • {l.qty}</div><div className="text-xs text-slate-400">{l.date}</div></div>
                                    <div className="flex gap-2"><button onClick={()=>printBT(l)} className="p-3 bg-slate-50 rounded-xl hover:bg-slate-100"><Printer/></button><button onClick={()=>{if(confirm('?')) setLogs(logs.filter(x=>x.id!==l.id))}} className="p-3 text-red-500 rounded-xl hover:bg-red-50"><Trash2/></button></div>
                                </div>
                                {l.type === 'recipe' && l.ingredients && <div className="mt-2 p-3 bg-slate-50 rounded-xl border text-xs"><div className="font-bold mb-2">Ingredienti</div>{l.ingredients.map((ing, i) => <div key={i} className="flex justify-between border-b py-1"><span>{ing.name}</span><span className="font-mono">{ing.lot}</span></div>)}</div>}
                            </div>
                        ))}
                    </div>
                )}

                {view === 'menu' && <MenuManager inventory={inventory} onUpdate={saveInv} />}
            </main>
        </div>
    );
}
