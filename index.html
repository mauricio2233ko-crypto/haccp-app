<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>HACCP Pro Vanilla</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- STILI CSS (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- OCR LIBRARY -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <!-- ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: sans-serif; touch-action: manipulation; padding-bottom: 50px; }
        .view { display: none; }
        .view.active { display: block; }
        .btn { @apply px-4 py-3 rounded-xl font-bold active:scale-95 transition shadow-sm flex items-center justify-center gap-2; }
        .btn-primary { @apply bg-slate-900 text-white shadow-xl; }
        .btn-sec { @apply bg-white border border-gray-200 text-gray-700; }
        .input { @apply w-full p-3 border-2 border-gray-200 rounded-xl text-lg outline-none focus:border-orange-500 transition-colors bg-white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #f97316; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-slate-900">

    <!-- HEADER -->
    <div class="bg-white p-4 sticky top-0 z-30 border-b flex justify-between items-center shadow-sm">
        <div class="font-bold text-lg flex items-center gap-2 text-orange-600">
            <i data-lucide="layers"></i> HACCP Pro
        </div>
        <div class="flex gap-2">
            <button onclick="router('home')" class="p-2 bg-gray-100 rounded hover:bg-gray-200"><i data-lucide="plus"></i></button>
            <button onclick="router('history')" class="p-2 bg-gray-100 rounded hover:bg-gray-200"><i data-lucide="history"></i></button>
            <button onclick="router('settings')" class="p-2 bg-gray-100 rounded hover:bg-gray-200"><i data-lucide="settings"></i></button>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <main class="p-4 max-w-lg mx-auto">
        
        <!-- VIEW: HOME (Produzione) -->
        <div id="view-home" class="view active space-y-4">
            <!-- Mode Switch -->
            <div class="flex bg-gray-200 p-1 rounded-xl">
                <button onclick="setMode('single')" id="btn-mode-single" class="flex-1 py-2 rounded-lg font-bold text-xs bg-white shadow transition">SINGOLO</button>
                <button onclick="setMode('recipe')" id="btn-mode-recipe" class="flex-1 py-2 rounded-lg font-bold text-xs text-gray-500 transition">RICETTA</button>
            </div>

            <!-- Categorie -->
            <div id="cat-list" class="flex flex-wrap gap-2 bg-white p-3 rounded-xl border shadow-sm"></div>

            <!-- Form -->
            <div class="bg-white p-5 rounded-xl border shadow-sm space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1">PRODOTTO</label>
                    <select id="sel-prod" class="input font-bold"></select>
                </div>

                <!-- Section Single -->
                <div id="sec-single">
                    <label class="text-xs font-bold text-gray-400 block mb-1">LOTTO</label>
                    <div class="flex gap-2">
                        <input id="inp-lot" class="input font-mono uppercase" placeholder="Lotto..." />
                        <button onclick="triggerCamera('lot')" class="p-3 bg-orange-100 text-orange-600 rounded-xl border-2 border-orange-200 active:scale-95">
                            <i data-lucide="camera"></i>
                        </button>
                    </div>
                </div>

                <!-- Section Recipe -->
                <div id="sec-recipe" class="hidden space-y-3">
                    <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 flex justify-between items-center text-indigo-800">
                        <div><div class="text-[10px] font-bold">LOTTO INTERNO</div><div id="txt-prep-lot" class="text-xl font-mono font-bold">PREP-...</div></div>
                        <i data-lucide="chef-hat"></i>
                    </div>
                    <div id="list-ing" class="text-sm space-y-1"></div>
                    <div class="p-3 bg-slate-50 border rounded-xl space-y-2">
                        <select id="sel-ing" class="w-full p-2 border rounded bg-white text-sm"></select>
                        <div class="flex gap-2">
                            <input id="inp-ing-qty" class="w-24 p-2 border rounded text-sm" placeholder="Q.tà">
                            <div class="flex-1 flex gap-1">
                                <input id="inp-ing-lot" class="flex-1 p-2 border rounded text-sm" placeholder="Lotto">
                                <button onclick="triggerCamera('ing')" class="p-2 bg-white border rounded"><i data-lucide="camera" style="width:16px"></i></button>
                            </div>
                        </div>
                        <button onclick="addIng()" class="w-full py-2 bg-slate-800 text-white rounded text-xs font-bold shadow">+ AGGIUNGI</button>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1">QUANTITÀ</label>
                    <input id="inp-qty" class="input" placeholder="Es. 5 Kg" />
                </div>

                <button onclick="saveLog()" class="btn btn-primary w-full text-lg">STAMPA ETICHETTA</button>
            </div>
        </div>

        <!-- VIEW: HISTORY -->
        <div id="view-history" class="view space-y-3">
            <h2 class="font-bold text-xl mb-4">Storico</h2>
            <div id="list-history" class="space-y-3"></div>
        </div>

        <!-- VIEW: SETTINGS -->
        <div id="view-settings" class="view space-y-6">
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                <h3 class="font-bold text-blue-900 mb-2 flex gap-2"><i data-lucide="cloud"></i> Cloud Sync</h3>
                <input id="inp-cloud-url" class="w-full p-2 border rounded text-xs mb-2" placeholder="https://script.google.com/..." />
                <button onclick="saveSettings()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-xs">SALVA</button>
            </div>

            <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-200">
                 <h3 class="font-bold text-emerald-900 mb-2 flex gap-2"><i data-lucide="file-spreadsheet"></i> Backup Menu</h3>
                 <div class="flex gap-2">
                     <button onclick="exportMenu()" class="flex-1 bg-emerald-600 text-white py-2 rounded font-bold text-xs shadow">EXPORT CSV</button>
                     <label class="flex-1 bg-white border border-emerald-600 text-emerald-700 py-2 rounded font-bold text-xs shadow text-center cursor-pointer">
                         IMPORT CSV <input type="file" onchange="importMenu(this)" class="hidden" accept=".csv">
                     </label>
                 </div>
            </div>

            <div class="bg-white p-4 rounded-xl border shadow-sm">
                <h3 class="font-bold mb-3">Gestione Rapida</h3>
                <div class="flex gap-2 mb-2">
                    <input id="inp-new-cat" class="flex-1 border p-2 rounded text-sm" placeholder="Nuova Categoria">
                    <button onclick="addCategory()" class="bg-slate-800 text-white px-3 rounded font-bold">+</button>
                </div>
                <div class="flex gap-2">
                    <input id="inp-new-prod" class="flex-1 border p-2 rounded text-sm" placeholder="Nuovo Prodotto">
                    <button onclick="addProduct()" class="bg-slate-800 text-white px-3 rounded font-bold">+</button>
                </div>
                <p class="text-xs text-gray-400 mt-2">Per eliminare, usa il file CSV.</p>
            </div>
            
            <div class="text-center pt-10">
                <button onclick="if(confirm('Cancellare tutto?')) { localStorage.clear(); location.reload(); }" class="text-red-500 text-xs underline">RESET TOTALE APP</button>
            </div>
        </div>

    </main>

    <!-- HIDDEN INPUT FOR CAMERA -->
    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="processImage(this)">

    <!-- LOADER OVERLAY -->
    <div id="loader" class="fixed inset-0 bg-black/80 z-50 hidden flex-col items-center justify-center text-white">
        <div class="loader mb-4"></div>
        <div id="loader-text" class="font-bold">Elaborazione...</div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- STATE ---
        const DEFAULT_INV = {
            impasti: { id: 'impasti', name: 'Impasti', products: ['Impasto Pizza', 'Pane'] },
            cucina: { id: 'cucina', name: 'Cucina', products: ['Sugo', 'Verdure'] }
        };
        
        let APP = {
            inv: DEFAULT_INV,
            logs: [],
            mode: 'single',
            catId: 'impasti',
            ings: [],
            scanTarget: '', // 'lot' or 'ing'
            cloudUrl: ''
        };

        // --- INIT ---
        window.onload = function() {
            try {
                const i = localStorage.getItem('h_inv'); if(i) APP.inv = JSON.parse(i);
                const l = localStorage.getItem('h_logs'); if(l) APP.logs = JSON.parse(l);
                const u = localStorage.getItem('h_url'); if(u) APP.cloudUrl = u;
                
                // Fix initial cat
                if(!APP.inv[APP.catId] && Object.keys(APP.inv).length > 0) {
                    APP.catId = Object.keys(APP.inv)[0];
                }
            } catch(e) { console.error("Init error", e); }
            
            updateUI();
            lucide.createIcons();
            
            // Set initial inputs
            document.getElementById('inp-cloud-url').value = APP.cloudUrl;
        };

        // --- UI UPDATERS ---
        function updateUI() {
            // Cats
            const catHtml = Object.values(APP.inv).map(c => 
                `<button onclick="setCat('${c.id}')" class="px-3 py-1 rounded-full border text-sm font-bold whitespace-nowrap ${APP.catId===c.id?'bg-orange-500 text-white':'bg-white'}">${c.name}</button>`
            ).join('');
            document.getElementById('cat-list').innerHTML = catHtml;

            // Prods
            const prods = APP.inv[APP.catId]?.products || [];
            const prodHtml = prods.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('sel-prod').innerHTML = prodHtml;

            // Ing Select (Optgroups)
            let ingHtml = '<option value="">Seleziona...</option>';
            Object.values(APP.inv).forEach(c => {
                ingHtml += `<optgroup label="${c.name}">${c.products.map(p=>`<option value="${p}">${p}</option>`).join('')}</optgroup>`;
            });
            document.getElementById('sel-ing').innerHTML = ingHtml;

            // Prep Lot
            const nextCount = parseInt(localStorage.getItem('prep_c') || '0') + 1;
            document.getElementById('txt-prep-lot').innerText = `PREP-${String(nextCount).padStart(4,'0')}`;

            // History
            const histHtml = APP.logs.map(l => `
                <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                    <div><div class="font-bold text-lg">${l.prod}</div><div class="text-sm text-gray-500">${l.lot} • ${l.qty}</div></div>
                    <button onclick="printLog('${l.id}')" class="p-2 bg-gray-100 rounded"><i data-lucide="printer"></i></button>
                </div>
            `).join('');
            document.getElementById('list-history').innerHTML = histHtml;

            // Ings List
            document.getElementById('list-ing').innerHTML = APP.ings.map(i => 
                `<div class="flex justify-between border-b pb-1 px-1"><span>${i.name} (${i.qty})</span><span class="font-mono text-xs">${i.lot}</span></div>`
            ).join('');
            
            lucide.createIcons();
        }

        // --- NAVIGATION ---
        window.router = (viewId) => {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+viewId).classList.add('active');
        };

        window.setMode = (m) => {
            APP.mode = m;
            document.getElementById('btn-mode-single').className = `flex-1 py-2 rounded-lg font-bold text-xs transition ${m==='single'?'bg-white shadow text-black':'text-gray-500'}`;
            document.getElementById('btn-mode-recipe').className = `flex-1 py-2 rounded-lg font-bold text-xs transition ${m==='recipe'?'bg-white shadow text-indigo-600':'text-gray-500'}`;
            document.getElementById('sec-single').style.display = m==='single' ? 'block' : 'none';
            document.getElementById('sec-recipe').style.display = m==='recipe' ? 'block' : 'none';
        };

        window.setCat = (id) => { APP.catId = id; updateUI(); };

        // --- ACTIONS ---
        window.saveSettings = () => {
            APP.cloudUrl = document.getElementById('inp-cloud-url').value.trim();
            localStorage.setItem('h_url', APP.cloudUrl);
            alert("Salvato");
        };

        window.addCategory = () => {
            const val = document.getElementById('inp-new-cat').value.trim();
            if(!val) return;
            const id = val.toLowerCase().replace(/\s/g,'');
            if(APP.inv[id]) return alert("Esiste già");
            APP.inv[id] = { id, name: val, products: [] };
            localStorage.setItem('h_inv', JSON.stringify(APP.inv));
            document.getElementById('inp-new-cat').value = '';
            setCat(id);
        };

        window.addProduct = () => {
            const val = document.getElementById('inp-new-prod').value.trim();
            if(!val) return;
            APP.inv[APP.catId].products.push(val);
            localStorage.setItem('h_inv', JSON.stringify(APP.inv));
            document.getElementById('inp-new-prod').value = '';
            updateUI();
        };

        window.addIng = () => {
            const name = document.getElementById('sel-ing').value;
            const qty = document.getElementById('inp-ing-qty').value;
            const lot = document.getElementById('inp-ing-lot').value;
            if(!name || !qty) return alert("Dati mancanti");
            APP.ings.push({ name, qty, lot: lot || 'N/A' });
            updateUI();
            document.getElementById('inp-ing-qty').value = '';
            document.getElementById('inp-ing-lot').value = '';
        };

        window.saveLog = async () => {
            const prod = document.getElementById('sel-prod').value;
            const qty = document.getElementById('inp-qty').value;
            let lot = document.getElementById('inp-lot').value;
            let finalIngs = null;

            if (APP.mode === 'recipe') {
                if (APP.ings.length === 0) return alert("Aggiungi ingredienti");
                lot = document.getElementById('txt-prep-lot').innerText;
                finalIngs = APP.ings;
                localStorage.setItem('prep_c', (parseInt(localStorage.getItem('prep_c')||'0')+1).toString());
            } else if (!lot) return alert("Inserisci Lotto");

            const item = { 
                id: Date.now().toString(), 
                date: new Date().toLocaleDateString(), 
                cat: APP.inv[APP.catId].name, 
                prod, lot, qty, 
                type: APP.mode, 
                ingredients: finalIngs 
            };

            APP.logs.unshift(item);
            localStorage.setItem('h_logs', JSON.stringify(APP.logs));

            // Cloud Send
            if (APP.cloudUrl) {
                fetch(APP.cloudUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                }).catch(e => console.error(e));
            }

            // Print
            await printBT(item);

            // Reset
            APP.ings = [];
            document.getElementById('inp-lot').value = '';
            document.getElementById('inp-qty').value = '';
            updateUI();
        };

        // --- SCANNER LOGIC (FOTO NATIVA + AI) ---
        window.triggerCamera = (target) => {
            APP.scanTarget = target;
            document.getElementById('camera-input').click();
        };

        window.processImage = async (input) => {
            const file = input.files[0];
            if(!file) return;
            
            showLoader("Analisi Immagine...");
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    // SE CLOUD CONFIGURATO -> USA GOOGLE AI
                    if (APP.cloudUrl) {
                        const base64 = e.target.result.split(',')[1];
                        // Nota: con no-cors non possiamo leggere la risposta.
                        // Per leggere la risposta (il lotto), l'URL deve supportare CORS o JSONP.
                        // Qui usiamo un fallback ibrido:
                        // 1. Tesseract locale (sicuro)
                        // 2. Se Google Script è configurato bene (return TextOutput), potremmo provare.
                        
                        // Per semplicità e robustezza in Vanilla su Tiiny: usiamo Tesseract locale sulla foto HD.
                        throw new Error("Local fallback");
                    } else {
                        throw new Error("No Cloud");
                    }
                } catch(err) {
                    // FALLBACK: Tesseract Locale su Foto HD
                    try {
                         const res = await Tesseract.recognize(file, 'eng');
                         const txt = res.data.text.replace(/[^A-Z0-9\-\/\.\s:]/g, '');
                         // Regex Lotto
                         const match = txt.match(/(?:L\.|L:|LOTTO|BATCH|LOT)[.\s]*([A-Z0-9]+)/i);
                         const final = match ? match[1] : txt.split(/\s+/).find(w => w.length > 4 && /\d/.test(w)) || txt.substring(0,10);
                         
                         if(APP.scanTarget === 'lot') document.getElementById('inp-lot').value = final;
                         else document.getElementById('inp-ing-lot').value = final;
                         
                    } catch(ocrErr) {
                        alert("Errore lettura: " + ocrErr);
                    }
                }
                hideLoader();
                input.value = ''; // reset
            };
            reader.readAsDataURL(file);
        };

        function showLoader(txt) { document.getElementById('loader').style.display='flex'; document.getElementById('loader-text').innerText=txt; }
        function hideLoader() { document.getElementById('loader').style.display='none'; }

        // --- CSV IMPORT/EXPORT ---
        window.exportMenu = () => {
            let csv = "Categoria,Prodotto\n";
            Object.values(APP.inv).forEach(c => c.products.forEach(p => csv += `${c.name},${p}\n`));
            const a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            a.download = 'menu.csv';
            a.click();
        };

        window.importMenu = (input) => {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                const lines = e.target.result.split('\n');
                lines.forEach((l, i) => {
                    if(i===0)return;
                    const [c,p] = l.split(',');
                    if(c&&p) {
                        const id = c.trim().toLowerCase().replace(/\s/g,'');
                        if(!APP.inv[id]) APP.inv[id] = {id, name:c.trim(), products:[]};
                        if(!APP.inv[id].products.includes(p.trim())) APP.inv[id].products.push(p.trim());
                    }
                });
                localStorage.setItem('h_inv', JSON.stringify(APP.inv));
                updateUI();
                alert("Fatto!");
            };
            r.readAsText(file);
        };

        // --- PRINT ---
        let printer = null;
        async function printBT(item) {
            try {
                if (!printer || !printer.gatt.connected) {
                    printer = await navigator.bluetooth.requestDevice({ filters: [{ name: '4B-2054L' }], optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] });
                    await printer.gatt.connect();
                }
                const svc = await printer.gatt.getPrimaryServices();
                const char = (await svc[0].getCharacteristics()).find(c => c.properties.write || c.properties.writeWithoutResponse);
                
                const enc = new TextEncoder();
                let cmds = `SIZE 60 mm,40 mm\nCLS\nTEXT 30,30,"3",0,1,1,"${item.prod}"\nTEXT 30,70,"2",0,1,1,"(${item.cat})"\nBAR 10,100,460,2\nTEXT 30,130,"2",0,1,1,"L: ${item.lot}"\nTEXT 300,130,"2",0,1,1,"Q: ${item.qty}"\n`;
                if(item.ingredients) {
                    let y = 160;
                    item.ingredients.forEach(i => { cmds += `TEXT 20,${y},"1",0,1,1,"- ${i.name} [${i.lot}]"\n`; y += 20; });
                }
                cmds += `BAR 10,270,460,2\nTEXT 30,285,"2",0,1,1,"${item.date}"\nPRINT 1\nEND`;
                
                const data = enc.encode(cmds);
                for (let i = 0; i < data.length; i += 100) await char.writeValue(data.slice(i, i + 100));
            } catch(e) { 
                console.log(e); 
                // Fallback browser print (utile per debug)
                // window.print(); 
            }
        }
        window.printLog = (id) => printBT(APP.logs.find(x=>x.id==id));

        // Start
        updateUI();
    </script>
</body>
</html>
