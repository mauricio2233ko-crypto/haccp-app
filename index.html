// --- INCOLLA QUI LA TUA CHIAVE API DI GEMINI ---
const GEMINI_API_KEY = "INCOLLA_QUI_LA_TUA_CHIAVE_AIza..."; 

function doPost(e) {
  var output = ContentService.createTextOutput();
  
  try {
    var jsonString = e.postData.contents;
    var request = JSON.parse(jsonString);

    // 1. RICHIESTA SCANSIONE FOTO (AI)
    if (request.action === "scan_image") {
      var result = analyzeWithGemini(request.image);
      output.setContent(JSON.stringify(result));
      output.setMimeType(ContentService.MimeType.JSON);
      return output;
    }

    // 2. RICHIESTA SALVATAGGIO DATI
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    if (sheet.getLastRow() === 0) sheet.appendRow(["Data", "Prod", "Cat", "Lotto", "Qta", "Note"]);
    
    sheet.appendRow([
      new Date(),
      request.date,
      request.cat,
      request.prod,
      request.lot,
      request.qty,
      request.ingredients ? JSON.stringify(request.ingredients) : request.type
    ]);
    
    output.setContent(JSON.stringify({ success: true }));
    output.setMimeType(ContentService.MimeType.JSON);
    return output;

  } catch (err) {
    output.setContent(JSON.stringify({ success: false, error: err.toString() }));
    output.setMimeType(ContentService.MimeType.JSON);
    return output;
  }
}

function analyzeWithGemini(base64Image) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  const payload = {
    contents: [{
      parts: [
        { text: "Analizza l'immagine. Estrai SOLO il codice del LOTTO (Batch Number). Rispondi SOLO con il codice alfanumerico pulito. Se non trovi nulla rispondi NULL." },
        { inline_data: { mime_type: "image/jpeg", data: base64Image } }
      ]
    }]
  };
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  try {
    const response = UrlFetchApp.fetch(url, options);
    const json = JSON.parse(response.getContentText());
    if(json.error) return { success: false, error: json.error.message };
    const text = json.candidates[0].content.parts[0].text.trim();
    return { success: true, lot: text };
  } catch(e) {
    return { success: false, error: e.toString() };
  }
}
