<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiSEFDQ1AgUHJvIiwiYHNob3J0X25hbWUiOiJIQUNDUCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjZjk3MzE2IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzEwNDYvMTA0Njg1Ny5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ=='>
    
    <title>HACCP Pro Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>

    <!-- MOTORE REACT E LIBRERIE -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "tesseract.js": "https://esm.sh/tesseract.js@5.0.3"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
    <div id="root">
        <div class="flex h-screen items-center justify-center text-slate-400 gap-2">
            <div class="animate-spin h-6 w-6 border-2 border-orange-500 border-t-transparent rounded-full"></div>
            Caricamento HACCP Pro...
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, Component } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Layers, Plus, History, Settings, Printer, Trash2, X, Camera, 
            ScanLine, Zap, ChefHat, Package, Check, Cloud, Link as LinkIcon, 
            Download, Upload, FileSpreadsheet, Lock, AlertTriangle, Smartphone, Loader2
        } from 'lucide-react';
        import Tesseract from 'tesseract.js';

        // --- ERROR BOUNDARY (Per evitare pagina bianca) ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return (
                    <div className="h-screen flex flex-col items-center justify-center p-6 text-center bg-red-50">
                        <AlertTriangle className="text-red-500 mb-4" size={48}/>
                        <h1 className="text-xl font-bold text-red-900">Errore Tecnico</h1>
                        <p className="text-xs text-red-600 mb-4 bg-white p-2 rounded border border-red-200">{this.state.error?.message}</p>
                        <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg">RESET APP</button>
                    </div>
                );
                return this.props.children;
            }
        }

        const DEFAULT_DATA = {
            impasti: { id: 'impasti', name: 'Impasti', products: ['Impasto Pizza', 'Pane'] },
            cucina: { id: 'cucina', name: 'Cucina', products: ['Sugo', 'Verdure'] }
        };

        // --- SCANNER NATIVO (FOTO) ---
        const NativeScanner = ({ onResult }) => {
            const [processing, setProcessing] = useState(false);
            const fileInputRef = useRef(null);

            const handleFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setProcessing(true);

                try {
                    // OCR Locale
                    const res = await Tesseract.recognize(file, 'eng', { 
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-/. :' 
                    });
                    
                    const text = res.data.text.replace(/[^A-Z0-9\-\/\.\s:]/g, '');
                    // Regex Lotto
                    const lotMatch = text.match(/(?:L\.|L:|LOTTO|BATCH|LOT)[.\s:]*([A-Z0-9\-\/]+)/i);
                    const cleanRaw = text.replace(/[^A-Z0-9\-\/]/g, '').trim();

                    if (lotMatch) onResult(lotMatch[1]);
                    else if (cleanRaw.length > 3) onResult(cleanRaw.substring(0, 15));
                    else alert("Nessun lotto chiaro trovato.");
                    
                } catch (err) { alert("Errore lettura: " + err); }
                
                setProcessing(false);
                if(fileInputRef.current) fileInputRef.current.value = '';
            };

            return (
                <div className="flex gap-2 items-center">
                    <input type="file" accept="image/*" capture="environment" ref={fileInputRef} onChange={handleFile} className="hidden" />
                    <button type="button" onClick={() => fileInputRef.current.click()} className="p-3 bg-orange-100 text-orange-600 rounded-xl border-2 border-orange-200 active:scale-95 transition-transform" disabled={processing}>
                        {processing ? <Loader2 className="animate-spin"/> : <Camera size={24}/>}
                    </button>
                </div>
            );
        };

        // --- GESTIONE MENU ---
        const MenuManager = ({ inventory, onUpdate }) => {
            const [newCat, setNewCat] = useState('');
            const [newProd, setNewProd] = useState('');
            const [selCat, setSelCat] = useState('');
            const [cloudUrl, setCloudUrl] = useState('');
            const [isSaved, setIsSaved] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const keys = Object.keys(inventory);
                if (keys.length > 0 && (!selCat || !inventory[selCat])) setSelCat(keys[0]);
                const s = localStorage.getItem('haccp_cloud_url');
                if(s) setCloudUrl(s);
            }, [inventory]);

            const saveUrl = () => { localStorage.setItem('haccp_cloud_url', cloudUrl.trim()); setIsSaved(true); setTimeout(()=>setIsSaved(false), 2000); };
            const addCat = () => { if(!newCat.trim()) return; const id=newCat.toLowerCase().replace(/\s/g,''); onUpdate({...inventory, [id]: {id, name:newCat, products:[]} }); setNewCat(''); setSelCat(id); };
            const delCat = (id) => { if(confirm('Eliminare Categoria?')) { const n={...inventory}; delete n[id]; onUpdate(n); } };
            const addProd = () => { if(!newProd) return; const c=inventory[selCat]; onUpdate({...inventory, [selCat]: {...c, products:[...c.products, newProd]}}); setNewProd(''); };
            const delProd = (p) => { if(confirm('Eliminare Prodotto?')) { const c=inventory[selCat]; onUpdate({...inventory, [selCat]: {...c, products:c.products.filter(x=>x!==p)}}); } };
            
            // Import/Export
            const exportData = () => {
                let csv = "Categoria,Prodotto\n";
                Object.values(inventory).forEach(c => c.products.forEach(p => csv += `${c.name},${p}\n`));
                const a = document.createElement('a');
                a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                a.download = 'menu.csv';
                a.click();
            };

            const importData = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    const lines = evt.target.result.split('\n');
                    const n = { ...inventory };
                    lines.forEach((l, i) => {
                        if(i===0) return;
                        const [c, p] = l.split(',');
                        if(c && p) {
                            const id = c.trim().toLowerCase().replace(/\s+/g, '');
                            if(!n[id]) n[id] = { id, name: c.trim(), products: [] };
                            if(!n[id].products.includes(p.trim())) n[id].products.push(p.trim());
                        }
                    });
                    onUpdate(n);
                    alert("Importato!");
                };
                r.readAsText(f);
            };

            return (
                <div className="p-4 space-y-6 pb-20 animate-in fade-in">
                    <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl">
                        <h3 className="font-bold text-blue-900 mb-2 flex gap-2"><Cloud size={20}/> Sincronizzazione Cloud</h3>
                        <p className="text-xs text-blue-600 mb-2">Incolla qui l'URL della Web App di Google Script:</p>
                        <div className="flex gap-2">
                            <input className="flex-1 p-2 border rounded text-sm" placeholder="https://script.google.com/..." value={cloudUrl} onChange={e=>setCloudUrl(e.target.value)}/>
                            <button onClick={saveUrl} className="bg-blue-600 text-white px-4 rounded font-bold">{isSaved?<Check/>:'SALVA'}</button>
                        </div>
                    </div>

                    <div className="bg-emerald-50 border border-emerald-200 p-4 rounded-xl">
                        <h3 className="font-bold text-emerald-900 mb-2 flex gap-2"><FileSpreadsheet size={20}/> Backup Menu</h3>
                        <div className="flex gap-2">
                            <button onClick={exportData} className="flex-1 bg-emerald-600 text-white py-2 rounded font-bold flex justify-center gap-2"><Download size={16}/> EXPORT</button>
                            <label className="flex-1 bg-white text-emerald-700 border-2 border-emerald-600 py-2 rounded font-bold flex justify-center gap-2 cursor-pointer"><Upload size={16}/> IMPORT <input type="file" className="hidden" onChange={importData} accept=".csv"/></label>
                        </div>
                    </div>

                    <h2 className="font-bold text-xl flex gap-2"><Settings className="text-orange-500"/> Gestione Menu</h2>
                    
                    {/* Categorie */}
                    <div className="bg-white p-4 rounded-xl border">
                        <div className="flex gap-2 mb-3">
                            <input className="flex-1 border p-2 rounded" placeholder="Nuova Categoria" value={newCat} onChange={e=>setNewCat(e.target.value)}/>
                            <button onClick={addCat} className="bg-slate-900 text-white px-4 rounded font-bold">OK</button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {Object.values(inventory).map(c => (
                                <button key={c.id} onClick={()=>setSelCat(c.id)} className={`px-3 py-1 rounded border text-sm font-bold flex items-center gap-2 ${selCat===c.id?'bg-orange-100 border-orange-300 text-orange-700':'bg-slate-50'}`}>
                                    {c.name} 
                                    {selCat===c.id && <span onClick={(e)=>{e.stopPropagation(); delCat(c.id)}} className="text-red-500 hover:bg-red-100 rounded px-1">x</span>}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Prodotti */}
                    <div className="bg-white p-4 rounded-xl border h-[400px] flex flex-col">
                        <h3 className="font-bold mb-2 text-slate-500">Prodotti in: {inventory[selCat]?.name}</h3>
                        <div className="flex gap-2 mb-2">
                            <input className="flex-1 border p-2 rounded" placeholder="Nuovo Prodotto" value={newProd} onChange={e=>setNewProd(e.target.value)}/>
                            <button onClick={addProd} className="bg-blue-600 text-white px-4 rounded font-bold">+</button>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-2">
                            {inventory[selCat]?.products.map((p, i) => (
                                <div key={i} className="flex justify-between items-center p-2 border rounded bg-slate-50">
                                    <span>{p}</span>
                                    <button onClick={()=>delProd(p)} className="text-red-400 p-1"><Trash2 size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP LOGIC ---
        function App() {
            const [view, setView] = useState('home');
            const [mode, setMode] = useState('single');
            const [inv, setInv] = useState(DEFAULT_DATA);
            const [logs, setLogs] = useState([]);
            
            const [catId, setCatId] = useState('impasti');
            const [prod, setProd] = useState('');
            const [lot, setLot] = useState('');
            const [qty, setQty] = useState('');
            const [prepLot, setPrepLot] = useState('');
            const [ings, setIngs] = useState([]);
            
            const [ingName, setIngName] = useState('');
            const [ingLot, setIngLot] = useState('');
            const [ingQty, setIngQty] = useState('');
            const printer = useRef(null);

            useEffect(() => {
                try {
                    const i = localStorage.getItem('haccp_inv_v5'); if(i) setInv(JSON.parse(i));
                    const l = localStorage.getItem('haccp_logs_v5'); if(l) setLogs(JSON.parse(l));
                    genLot();
                } catch(e){}
            }, []);

            useEffect(() => {
                const cat = inv[catId];
                if(cat) {
                    if(cat.products.length) setProd(cat.products[0]); else setProd('');
                } else if(Object.keys(inv).length) setCatId(Object.keys(inv)[0]);
            }, [inv, catId]);

            const saveInv = (n) => { setInv(n); localStorage.setItem('haccp_inv_v5', JSON.stringify(n)); };
            const genLot = () => { const c = parseInt(localStorage.getItem('prep_c')||'0')+1; setPrepLot(`PREP-${String(c).padStart(4,'0')}`); };

            const addLog = async (e) => {
                e.preventDefault();
                let fLot=lot, fIngs=null;
                if(mode==='recipe') {
                    if(!ings.length) return alert('Aggiungi ingredienti!');
                    fLot = prepLot; fIngs = ings;
                    localStorage.setItem('prep_c', (parseInt(localStorage.getItem('prep_c')||'0')+1).toString());
                    genLot();
                } else if(!lot) return alert('Manca il lotto!');

                const item = { id: Date.now(), date: new Date().toISOString().split('T')[0], cat: inv[catId]?.name, prod: prod||'?', lot: fLot, qty, type: mode, ingredients: fIngs };
                const nLogs = [item, ...logs];
                setLogs(nLogs);
                localStorage.setItem('haccp_logs_v5', JSON.stringify(nLogs));

                const url = localStorage.getItem('haccp_cloud_url');
                if(url) fetch(url, { method:'POST', mode:'no-cors', body:JSON.stringify(item) }).catch(()=>{});
                
                await print(item);
                setLot(''); setQty(''); setIngs([]);
            };

            const wrapText = (text, maxChars) => {
                const words = text.split(' ');
                let lines = [], currentLine = words[0];
                for (let i = 1; i < words.length; i++) {
                    if (currentLine.length + 1 + words[i].length <= maxChars) currentLine += ' ' + words[i];
                    else { lines.push(currentLine); currentLine = words[i]; }
                }
                lines.push(currentLine);
                return lines;
            };

            const print = async (item) => {
                try {
                    let dev = printer.current;
                    if(!dev || !dev.gatt.connected) {
                        dev = await navigator.bluetooth.requestDevice({ filters:[{name:'4B-2054L'}], optionalServices:['000018f0-0000-1000-8000-00805f9b34fb'] });
                        await dev.gatt.connect();
                        printer.current = dev;
                    }
                    const svc = await dev.gatt.getPrimaryServices();
                    const char = (await svc[0].getCharacteristics()).find(c=>c.properties.write || c.properties.writeWithoutResponse);
                    const enc = new TextEncoder();
                    
                    let y = 30;
                    let cmds = `SIZE 60 mm,40 mm\nCLS\nBOX 10,10,470,310,3\n`;
                    const pLines = wrapText(item.prod, 18);
                    pLines.forEach(l => { cmds += `TEXT 240,${y},"3",0,1,1,2,"${l}"\n`; y+=35; });
                    cmds += `TEXT 240,${y},"2",0,1,1,2,"(${item.cat})"\n`; y+=30;
                    cmds += `BAR 10,${y},460,2\n`; y+=10;
                    cmds += `TEXT 30,${y},"2",0,1,1,"L: ${item.lot}"\n`;
                    cmds += `TEXT 300,${y},"2",0,1,1,"Q: ${item.qty}"\n`;
                    y+=35;

                    if(item.ingredients) {
                        item.ingredients.forEach(i => {
                            const line = `- ${i.name} [${i.lot}]`;
                            const iLines = wrapText(line, 40);
                            iLines.forEach(l => { if(y<265) { cmds += `TEXT 20,${y},"1",0,1,1,"${l}"\n`; y+=20; } });
                        });
                    }
                    cmds += `BAR 10,270,460,2\nTEXT 30,285,"2",0,1,1,"${item.date}"\nTEXT 300,285,"2",0,1,1,"Scad: +3gg"\nPRINT 1\nEND`;
                    
                    const data = enc.encode(cmds);
                    for(let i=0; i<data.length; i+=100) await char.writeValue(data.slice(i, i+100));
                } catch(e) { alert("Stampa BT Fallita. Uso browser."); window.print(); }
            };

            const addIng = () => { if(!ingName||!ingQty) return alert("Dati mancanti"); setIngs([...ings, {name:ingName, lot:ingLot||'N/A', qty:ingQty}]); setIngName(''); setIngLot(''); setIngQty(''); };

            return (
                <div className="min-h-screen pb-20 bg-slate-50">
                    <header className="bg-white p-4 sticky top-0 z-30 border-b flex justify-between shadow-sm">
                        <div className="font-bold text-lg flex items-center gap-2"><Layers className="text-orange-500"/> HACCP Pro</div>
                        <div className="flex gap-2">
                            <button onClick={()=>setView('home')} className={`p-2 rounded-lg ${view==='home'?'bg-slate-100':''}`}><Plus/></button>
                            <button onClick={()=>setView('history')} className={`p-2 rounded-lg ${view==='history'?'bg-slate-100':''}`}><History/></button>
                            <button onClick={()=>setView('menu')} className={`p-2 rounded-lg ${view==='menu'?'bg-slate-100':''}`}><Settings/></button>
                        </div>
                    </header>

                    <main className="p-4 max-w-5xl mx-auto animate-in fade-in">
                        {view === 'home' && (
                            <div className="grid md:grid-cols-12 gap-6">
                                <div className="md:col-span-5 space-y-4">
                                    <div className="flex bg-slate-200 p-1 rounded-2xl">
                                        <button onClick={()=>setMode('single')} className={`flex-1 py-3 rounded-xl font-bold text-sm ${mode==='single'?'bg-white shadow':''}`}>SINGOLO</button>
                                        <button onClick={()=>setMode('recipe')} className={`flex-1 py-3 rounded-xl font-bold text-sm ${mode==='recipe'?'bg-white shadow':''}`}>RICETTA</button>
                                    </div>
                                    <div className="bg-white p-4 rounded-2xl border shadow-sm flex flex-wrap gap-2">
                                        {Object.values(inv).map(c => <button key={c.id} onClick={()=>{setCatId(c.id); if(c.products.length) setProd(c.products[0]); else setProd('')}} className={`px-4 py-2 rounded-lg font-bold text-sm border ${catId===c.id?'bg-orange-500 text-white':'bg-slate-50'}`}>{c.name}</button>)}
                                    </div>
                                    <div className="bg-white p-4 rounded-2xl border shadow-sm">
                                        <select className="w-full p-4 bg-slate-50 border-2 rounded-xl font-bold text-lg outline-none" value={prod} onChange={e=>setProd(e.target.value)}>{inv[catId]?.products.map(p=><option key={p} value={p}>{p}</option>)}</select>
                                    </div>
                                </div>
                                <div className="md:col-span-7 bg-white p-6 rounded-2xl border shadow-sm">
                                    <form onSubmit={addLog} className="space-y-6">
                                        {mode==='single' ? (
                                            <div><label className="text-xs font-bold text-slate-400 mb-1 block">LOTTO ORIGINE</label><div className="flex gap-2"><input value={lot} onChange={e=>setLot(e.target.value)} className="flex-1 p-4 border-2 rounded-xl font-mono text-lg uppercase" placeholder="SCAN..." /><NativeScanner onResult={setLot} /></div></div>
                                        ) : (
                                            <div className="space-y-4">
                                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex justify-between items-center"><div><div className="text-[10px] font-bold text-indigo-400">LOTTO INTERNO</div><div className="text-2xl font-mono font-bold text-indigo-700">{prepLot}</div></div><ChefHat className="text-indigo-300" size={32}/></div>
                                                <div className="space-y-2">{ings.map((i,k)=><div key={k} className="flex justify-between bg-slate-50 p-2 rounded text-sm border"><span className="font-bold">{i.name} ({i.qty})</span><span className="font-mono">{i.lot}</span></div>)}</div>
                                                <div className="p-4 bg-slate-50 rounded-xl border space-y-3"><select className="w-full p-3 border rounded-lg bg-white" value={ingName} onChange={e=>setIngName(e.target.value)}><option value="">Seleziona...</option>{Object.values(inv).map(c=><optgroup key={c.id} label={c.name}>{c.products.map(p=><option key={p} value={p}>{p}</option>)}</optgroup>)}</select><div className="flex gap-2"><input className="w-24 p-3 border rounded-lg" placeholder="Q.tà" value={ingQty} onChange={e=>setIngQty(e.target.value)}/><div className="flex-1 flex gap-2"><input className="flex-1 p-3 border rounded-lg" placeholder="Lotto" value={ingLot} onChange={e=>setIngLot(e.target.value)}/><NativeScanner onResult={setIngLot} /></div></div><button type="button" onClick={addIng} className="w-full py-3 bg-slate-800 text-white rounded-lg font-bold text-sm">+ AGGIUNGI</button></div>
                                            </div>
                                        )}
                                        <div><label className="text-xs font-bold text-slate-400 ml-1 mb-1 block">QUANTITÀ</label><input value={qty} onChange={e=>setQty(e.target.value)} className="w-full p-4 border-2 rounded-xl font-bold text-lg" placeholder="Es. 5 Kg"/></div>
                                        <button type="submit" className="w-full py-5 bg-slate-900 text-white rounded-2xl font-bold text-xl shadow-xl flex justify-center gap-3 items-center">STAMPA <Printer size={24}/></button>
                                    </form>
                                </div>
                            </div>
                        )}
                        {view === 'history' && (
                            <div className="max-w-2xl mx-auto space-y-4">
                                <h2 className="font-bold text-2xl mb-6">Storico</h2>
                                {logs.map(l => (
                                    <div key={l.id} className="bg-white p-5 rounded-2xl border shadow-sm flex flex-col gap-3">
                                        <div className="flex justify-between items-start">
                                            <div><span className="font-bold text-lg text-slate-800">{l.prod}</span><div className="text-sm text-slate-500">Lotto: {l.lot} • {l.qty}</div><div className="text-xs text-slate-400">{l.date}</div></div>
                                            <div className="flex gap-2"><button onClick={()=>printBT(l)} className="p-3 bg-slate-50 rounded-xl hover:bg-slate-100"><Printer/></button><button onClick={()=>{if(confirm('?')) setLogs(logs.filter(x=>x.id!==l.id))}} className="p-3 text-red-500 rounded-xl hover:bg-red-50"><Trash2/></button></div>
                                        </div>
                                        {l.type === 'recipe' && l.ingredients && <div className="mt-2 p-3 bg-slate-50 rounded-xl border text-xs"><div className="font-bold mb-2">Ingredienti</div>{l.ingredients.map((ing, i) => <div key={i} className="flex justify-between border-b py-1"><span>{ing.name}</span><span className="font-mono">{ing.lot}</span></div>)}</div>}
                                    </div>
                                ))}
                            </div>
                        )}
                        {view === 'menu' && <MenuManager inventory={inv} onUpdate={saveInv} />}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
